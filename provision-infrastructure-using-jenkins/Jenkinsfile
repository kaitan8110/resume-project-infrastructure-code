pipeline {
    agent any
    environment {
        AWS_ACCESS_KEY_ID = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION = "ap-southeast-1"
        SKIP = "N"
        TERRADESTROY = "N"
        FIRST_DEPLOY = "Y"
        STATE_BUCKET = "terraform-state-bucket-unique123456"  // Ensure this name is unique
        ANSIBLE_BUCKET_NAME = "ansible-state-bucket-unique123456"  // Ensure this name is unique
        ANSIBLE_SSH_PRIVATE_KEY = credentials('ansible-ssh-key')
    }

    stages {
        stage("Create Terraform State Buckets") {
            when {
                allOf {
                    environment name: 'FIRST_DEPLOY', value: 'Y'
                    environment name: 'TERRADESTROY', value: 'N'
                    environment name: 'SKIP', value: 'N'
                }
            }
            steps {
                script {
                    def bucketExists = sh(
                        script: "aws s3 ls s3://${STATE_BUCKET}",
                        returnStatus: true
                    ) == 0

                    if (!bucketExists) {
                        sh "aws s3 mb s3://${STATE_BUCKET}"
                    } else {
                        echo "Bucket ${STATE_BUCKET} already exists, skipping creation."
                    }
                }
            }
        }

        stage("Deploy Ansible Infra") {
            when {
                allOf {
                    environment name: 'TERRADESTROY', value: 'N'
                    environment name: 'SKIP', value: 'N'
                }
            }
            stages {
                stage('Validate Ansible Infra') {
                    steps {
                        sh '''
                        cd provision-infrastructure-using-jenkins/terraform/s3-bucket
                        terraform init
                        terraform validate
                        '''
                    }
                }
                stage('Deploy Ansible Infra') {
                    steps {
                        sh '''
                        cd provision-infrastructure-using-jenkins/terraform/s3-bucket
                        terraform plan -out outfile
                        terraform apply outfile
                        '''
                    }
                }
            }
        }

        stage("Deploy Networking"){
            when {
                allOf {
                    environment name:'TERRADESTROY',value:'N'
                    environment name:'SKIP',value:'N'
                }
            }
            stages {
                stage('Validate n/w Infra'){
                    steps {
                        sh '''
                        cd provision-infrastructure-using-jenkins/terraform/networking
                        terraform init
                        terraform validate
                        '''
                    }
                }
                stage('Deploy n/w Infra'){
                    steps{
                        sh '''
                        cd provision-infrastructure-using-jenkins/terraform/networking
                        terraform plan -out outfile
                        terraform apply outfile
                        '''
                    }
                }
            }

        }

        stage("Deploy Controlplane"){
             when {
                allOf {
                    environment name:'TERRADESTROY',value:'N'
                    environment name:'SKIP',value:'N'
                }
            }
            stages {
                stage("Deploy controlplane"){
                    when {
                        environment name:'SKIP',value:'N'
                    }
                    stages{
                        stage('Validate controlplane infra'){
                            steps{
                                sh '''
                                cd provision-infrastructure-using-jenkins/terraform/kube-control-plane
                                terraform init
                                terraform validate
                                '''
                            }
                        }
                        stage('Deploy controlplane infra'){
                            steps{
                                sh '''
                                cd provision-infrastructure-using-jenkins/terraform/kube-control-plane
                                terraform plan -out outfile
                                terraform apply outfile
                                '''
                            }
                        }
                        stage('Prepare inv file'){
                            when {
                                environment name:'SKIP',value:'N'
                            }
                            steps{
                                script {
                                    sh """
                                    ansible --version
                                    cd ansible_infra
                                    cd ansible_playbooks
                                    env
                                    ansible-playbook identify_controlplane.yml -i inv
                                    cat inv
                                    """
                                }
                            }
                        }
                    }
                }

            }
            

        }

        // Additional stages as defined in your original Jenkinsfile
        // Ensure that each stage follows the correct indentation and syntax

    }

    post {
        always {
            cleanWs()
        }
    }
}
