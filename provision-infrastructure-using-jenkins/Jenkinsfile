pipeline {
    agent any
    environment {
        AWS_ACCESS_KEY_ID = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION = "ap-southeast-1"
        SKIP = "N"
        TERRADESTROY = "N"
        FIRST_DEPLOY = "Y"
        STATE_BUCKET = "terraform-state-bucket-unique123456"  // Ensure this name is unique
        ANSIBLE_BUCKET_NAME = "ansible-state-bucket-unique123456"  // Ensure this name is unique
    }

    stages {
        stage("Create Terraform State Buckets") {
            when {
                allOf {
                    environment name: 'FIRST_DEPLOY', value: 'Y'
                    environment name: 'TERRADESTROY', value: 'N'
                    environment name: 'SKIP', value: 'N'
                }
            }
            steps {
                script {
                    def bucketExists = sh(
                        script: "aws s3 ls s3://${STATE_BUCKET}",
                        returnStatus: true
                    ) == 0

                    if (!bucketExists) {
                        sh "aws s3 mb s3://${STATE_BUCKET}"
                    } else {
                        echo "Bucket ${STATE_BUCKET} already exists, skipping creation."
                    }
                }
            }
        }

        stage("Deploy Ansible Infra") {
            when {
                allOf {
                    environment name: 'TERRADESTROY', value: 'N'
                    environment name: 'SKIP', value: 'N'
                }
            }
            stages {
                stage('Validate Ansible Infra') {
                    steps {
                        sh '''
                        cd terraform/s3-bucket
                        terraform init
                        terraform validate
                        '''
                    }
                }
                stage('Deploy Ansible Infra') {
                    steps {
                        sh '''
                        cd terraform/s3-bucket
                        terraform plan -out outfile
                        terraform apply outfile
                        '''
                    }
                }
            }
        }

        // Additional stages as defined in your original Jenkinsfile
        // Ensure that each stage follows the correct indentation and syntax

    }

    post {
        always {
            cleanWs()
        }
    }
}
